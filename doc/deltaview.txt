*deltaview.txt*  delta diff inside neovim as an inline diff view

Author: kokusenz
License: MIT

==============================================================================
CONTENTS                                                  *deltaview-contents*

    1. Introduction ........................ |deltaview-introduction|
    2. Setup ............................... |deltaview-setup|
    3. Commands ............................ |deltaview-commands|
    4. Configuration ....................... |deltaview-config|
    5. Module Functions .................... |deltaview-functions|
    7. Keybindings ......................... |deltaview-keybindings|
    6. Vim UI Select ....................... |deltaview-ui-select|

==============================================================================
INTRODUCTION                                          *deltaview-introduction*

Current inline/unified diff viewers in neovim tend to use virtual lines to display negative changes. Cursors cannot land on virtual lines, and a large scope of negative changes will be skipped over when scrolling through a file, making it an unintuitive and flawed way to view a diff.

This plugin takes a less intrusive approach; display the delta pager output in a terminal buffer. These buffers are temporary and integrate seamlessly within a coding experience, using configurable keybinds to quickly swap in and out. Have you ever felt like you needed your lsp while reviewing a PR in your browser? Review the changes in neovim, using deltaview.nvim, and follow the code with your keyboard instead of your eyes.

If you aren't looking for an inline diff view, or are just looking for a code review tool that is mature and feature rich, [codediff.nvim](https://github.com/esmuellert/codediff.nvim/blob/main/README.md) may be a better fit for you. This is a tool for those who prefer inline diff views.

==============================================================================
SETUP/CONFIGURATION                                               *deltaview-setup*, *deltaview-configuration*

No configuration is needed by default. If you want to change the configured defaults, you must put the setup in the `after/plugin/` directory. These are the options

setup>lua
require('deltaview').setup({
  -- Use delta.lua as the diff viewer if true, uses dandavison/delta if false
  use_delta_lua = true

  -- Enable nerd font icons for a prettier UI
  use_nerdfonts = true,

  -- Show both previous and next filenames when navigating
  -- false: shows "[2/5] -> next.lua"
  -- true: shows "<- prev.lua [2/5] -> next.lua"
  show_verbose_nav = false,

  -- Configures the position of the quick select opened by DeltaMenu when under the fzf_threshold
  -- 'hsplit': horizontal split window
  -- 'center': centered floating window
  -- 'bottom': centered at the bottom, floating window
  quick_select_view = 'hsplit',

  -- Number of files threshold for switching to fzf
  -- When the number of modified files >= this value, use fzf instead of quickselect
  -- Set to 0 or 1 to always use fzf
  fzf_threshold = 6,

  -- Custom keybindings
  keyconfig = {
    -- Global keybind to toggle DeltaMenu
    dm_toggle_keybind = "<leader>dm",

    -- Global keybind to toggle DeltaView (and exit diff if open)
    dv_toggle_keybind = "<leader>dl",

    -- Global keybind to toggle Delta (and exit diff if open)
    d_toggle_keybind = "<leader>da",

    -- Navigate between hunks in a diff
    next_hunk = "<Tab>",
    prev_hunk = "<S-Tab>",

    -- Navigate between files (when opened from DeltaMenu)
    next_diff = "]f",
    prev_diff = "[f",

    -- Change diff menu view to quickselect (when in fzf mode)
    fzf_toggle = "alt-;",

    -- Jump to line in view opened by Delta
    jump_to_line = "<CR>"
  }
})

==============================================================================
COMMANDS                                                  *deltaview-commands*

                                                                *:DeltaView*
:DeltaView [ref]        Opens the delta diff view on the buffer you are on. Uses the last ref that was used, or HEAD by default if ref is omitted. This uses Delta's syntax highlighting to mock an inline view of the full file with two way cursor tracking. The cursor is placed at the right location upon entry, and placed at the right location upon exit.

                                                                *:DeltaMenu*
:DeltaMenu [ref]        Opens the delta diff menu of the git directory. Uses the last ref that was used, or HEAD by default if ref is omitted.

                                                                *:Delta*
:Delta [ref] [context] [path]    Opens the delta diff view with configurable context for a path, without two way cursor tracking. Uses the last ref that was used, or HEAD by default. Uses the last specified context size, or 3 by default. Uses the current path (use netrw or some other filetree plugin to nav to it), or a specified path.

==============================================================================
MODULE FUNCTIONS                                            *deltaview-functions*
The module exposed by require('deltaview') exposes .setup({}) for configuration, but also exposes two bonus functions.

                                                                *is_deltaview_buffer*
is_deltaview_buffer(bufnr)  Checks if a buffer is a deltaview diff buffer. Takes in a buffer id, or defaults to current buffer if param is nil. Intended for personal scripting.

                                                                *register_ui_select*
register_ui_select([select_view])
    Registers the DeltaView quick picker as your default vim.ui.select.
    Comes with automatic label extraction, wrapped line height calculation,
    and expanded configuration options.

    Parameters:
        select_view  (string, optional)
            Default window position for all vim.ui.select calls.
            Valid values: 'center', 'bottom', 'hsplit'
            Default: 'center'

            Individual vim.ui.select calls can override this default by
            providing the win_predefined option.

==============================================================================
KEYBINDINGS                                            *deltaview-keybindings*

Global keybindings:

| Key | Action |
|-----|--------|
| `<leader>dl` | :DeltaView |
| `<leader>dm` | :DeltaMenu |
| `<leader>da` | :Delta |

When viewing a diff (DeltaView):

| Key | Action |
|-----|--------|
| `<Tab>` | Next hunk |
| `<S-Tab>` | Previous hunk |
| `]f` | Open next file in menu (if opened from DeltaMenu, or in Delta with multiple files) |
| `[f` | Open previous file in menu (if opened from DeltaMenu, or in Delta with multiple files) |

When viewing a diff (Delta):

| Key | Action |
|-----|--------|
| `<CR>` | Jump to line |

When in the file menu:

| Key | Action |
|-----|--------|
| Select a file | Open diff for that file |
| `alt-;` | Change fzf to quickselect (in fzf mode) |

==============================================================================
VIM.UI.SELECT INTERFACE                                   *deltaview-ui-select*

DeltaView provides a custom vim.ui.select implementation that extends the
standard Neovim interface with additional features like automatic label
extraction, wrapped line height calculation, and configurable window
positioning. This is used for the default quick select in DeltaMenu, but can be used in other applications.

To use it as your default picker: >lua
    -- Use default 'center' window position
    require('deltaview').register_ui_select()

    -- Or configure a custom default position
    require('deltaview').register_ui_select('hsplit')
<

STANDARD OPTIONS                          *deltaview-ui-select-standard-opts*

These options are compatible with standard vim.ui.select:

    prompt           (string, optional)
        Title displayed in the window border or as buffer name.
        Default: 'Select item'

    kind             (string, optional)
        Arbitrary hint string (standard vim.ui.select, currently unused).

    format_item      (function, optional)
        Function to format items for display.
        Signature: function(item) -> string
        Default: tostring

DELTAVIEW EXTENSIONS                     *deltaview-ui-select-extension-opts*

Additional options specific to DeltaView's implementation:

    win_predefined   (string, optional)
        Window position type for this specific vim.ui.select call.
        Options:
        - 'center'  : Centered floating window with border
        - 'bottom'  : Floating window at bottom of screen with border
        - 'hsplit'  : Horizontal split below current window

        Default: 'center' (or the default set via register_ui_select())

        Note: This option overrides the configured default on a per-call
              basis, allowing you to use different window positions for
              different selection contexts.

    label_item       (function, optional)
        Factory function that returns a label extractor function.
        The factory is called twice: once to generate display labels,
        and once to generate keybinding labels.

        Signature: function() -> function(item) -> string

        The returned function should:
        - Extract a single-character label from each item
        - Return unique labels for each item
        - Labels become single-key shortcuts to select items

        Default: Extracts first unused lowercase character from
                 formatted item string

    additional_data  (table, optional)
        Extra data to display alongside items.
        Format: { [item] = {string, string, ...} }

        Each item can have a list of strings that will be displayed
        after the item text, separated by ' │ '.

        Example: { ["file.lua"] = {"+10", "-5"} }
        Displays: "f: file.lua    │    +10 -5"

    win_opts         (table, optional)
        Custom window options to completely override defaults.
        Should be a valid nvim_open_win() config table.
        When provided, win_predefined is ignored.

SELECTION KEYBINDINGS                      *deltaview-ui-select-keybindings*

When the selection window is active:

    <letter>         Select item with that label (auto-generated)
    j / k            Navigate down / up
    <CR>             Select item at cursor
    <Esc>            Cancel selection

    Note: Labels that conflict with navigation keys (j, k, Esc, CR)
          will not have keybindings set.

EXAMPLES                                       *deltaview-ui-select-examples*

Basic usage with default center window: >lua
    vim.ui.select({'Option 1', 'Option 2', 'Option 3'}, {
        prompt = 'Choose an option',
    }, function(choice, idx)
        if choice then
            print('Selected: ' .. choice)
        end
    end)
<

Using hsplit window for file selection: >lua
    local files = {'init.lua', 'config.lua', 'utils.lua'}
    vim.ui.select(files, {
        prompt = 'Select File',
        win_predefined = 'hsplit',
    }, function(file, idx)
        if file then
            vim.cmd('edit ' .. file)
        end
    end)
<

Advanced: Custom formatting with additional data: >lua
    local commits = {
        {hash = 'a1b2c3d', msg = 'Fix bug'},
        {hash = 'e4f5g6h', msg = 'Add feature'},
    }

    local additional_data = {}
    for _, commit in ipairs(commits) do
        additional_data[commit] = {commit.hash}
    end

    vim.ui.select(commits, {
        prompt = 'Select Commit',
        format_item = function(commit)
            return commit.msg
        end,
        additional_data = additional_data,
        win_predefined = 'bottom',
    }, function(commit, idx)
        if commit then
            print('Selected: ' .. commit.hash)
        end
    end)
<
    Display format: >
        f: Fix bug    │    a1b2c3d
        a: Add feature    │    e4f5g6h
<
